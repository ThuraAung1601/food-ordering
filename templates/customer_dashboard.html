<!DOCTYPE html>
<html>
<head>
    <title>Customer Dashboard</title>
    <link rel="stylesheet" type="text/css" href="/static/style/css/customer.css"/>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="/static/style/css/admin.css" rel="stylesheet"/>
</head>
<body>
    <div class="customer-container">
        <nav class="customer-nav">
            <div class="nav-header">
                <i class='bx bx-restaurant logo-icon'></i>
                <h1>Silver Leaf</h1>
            </div>
            <ul class="nav-links">
                <li>
                    <a href="javascript:void(0);" id="ordersTab" onclick="showSection('orders')">
                        <i class='bx bx-food-menu'></i>
                        <span>Orders</span>
                    </a>
                </li>
                <li>
                    <a href="javascript:void(0);" onclick="showMenu(event)">
                        <i class='bx bx-restaurant'></i>
                        <span>Menu</span>
                    </a>
                </li>
                <li>
                    <a href="javascript:void(0);" onclick="showCart(event)">
                        <i class='bx bx-cart'></i>
                        <span>My Cart</span>
                    </a>
                </li>
                <li>
                    <a href="/" onclick="handleLogOut(event)">
                        <i class='bx bx-log-out'></i>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="content">
            <div class="header">
                <h2>Welcome Back!</h2>
                <div class="user-info">
                    <i class='bx bx-user-circle'></i>
                    <span id="customerName"></span>
                </div>
            </div>

            <section id="menu" class="dashboard-section">
                <div class="section-header">
                    <h2>Our Menu</h2>
                </div>
                <div id="menuList" class="menu-grid">
                    {% for menu in menus %}
                        <div class="menu-card" style="border: 1px solid black;">
                            <h3>{{ menu.name }}</h3>
                            
                
                            <div class="menu-actions">
                                {% if menu.items %}  <!-- Only display if there are items -->
                                    {% for item in menu["items"] %}

                                        <div class="item-card">
                                            <img src="{% if item.photo_url %}{{ item.photo_url }}{% else %}/static/style/img/burger.png{% endif %}" 
                                                 alt="{{ item.name }}"
                                                 style="width: 50%; height: 50%;" />
                                            <div class="item-details">
                                                <h4>{{ item.name }}</h4>
                                                <p>{{ item.description }}</p>
                                                <p>Price: ${{ "%.2f"|format(item.price) }}</p>  <!-- Ensure two decimal places -->
                
                                                <button onclick="addToCart('{{ item.name }}')">
                                                    Add to Cart
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <p>No items available in this menu.</p>  <!-- If menu has no items -->
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <p>No menus available.</p>  <!-- If menus list is empty -->
                    {% endfor %}
                </div>
                
            </section>
            
           
            <section id="cart" class="dashboard-section">
                <div class="section-header">
                    <h2>My Cart</h2>
                </div>
                <div id="cartItems" class="cart-grid">
                    <!-- Cart items will be displayed here -->
                </div>
            </section>

            <section id="orders" class="dashboard-section">
                <div class="section-header">
                    <h2>Your Orders</h2>
                    <button onclick="refreshOrders()" style="margin-left: 10px;">
                        <i class='bx bx-refresh'></i> Refresh
                    </button>
                </div>
                <div id="orderList" class="order-grid">
                    {% if orders %}
                        {% for order in orders %}
                            <div class="order-card">
                                <div class="order-header">
                                    <h3>Order #{{ order.order_id[:8] }}</h3>
                                    <span class="status {{ order.status.lower() }}">{{ order.status }}</span>
                                </div>
                                <div class="order-details">
                                    <div class="items-list">
                                        {% for item in order["items"] %}
                                            <div class="order-item">
                                                <span class="item-name">{{ item.name }}</span>
                                                <span class="item-price">${{ "%.2f"|format(item.price) }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <div class="order-summary">
                                        <p>Total: ${{ "%.2f"|format(order.total_price) }}</p>
                                        <p>Delivery to: {{ order.delivery_address }}</p>
                                        <p>Ordered: {{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                                        {% if order.estimated_delivery %}
                                            <p>Estimated Delivery: {{ order.estimated_delivery.strftime('%H:%M') }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>No orders found.</p>
                    {% endif %}
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            showSection('orders');
            const ordersLink = document.querySelector('a[onclick="showSection(\'orders\')"]');
            if (ordersLink) {
                ordersLink.classList.add('active');
            }
        });
    
        function showMenu(event) {
            event.preventDefault();
            loadMenuSection();

            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }

        function showSection(sectionId) {
            
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.style.display = 'none'; 
            });
    
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
                
                // Update URL path for orders section
                if (sectionId === 'orders') {
                    const username = pathSegments[2];
                    const newPath = `/customers/${username}/orders`;  // Changed from /order/confirm to /orders
                    history.pushState(null, '', newPath);
                }
            } else {
                console.error(`Section with ID '${sectionId}' not found.`);
            }
    
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active');
            });
    
            const activeLink = document.querySelector(`a[onclick="showSection('${sectionId}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        function loadMenuSection() {
            const pathSegments = window.location.pathname.split('/');
            const username = pathSegments[2];
            
            const newPath = `/customers/${username}/menus`; 
          
            history.pushState(null, '', newPath); 
            showSection('menu');
            
        }
        const pathSegments = window.location.pathname.split('/');
        const username = pathSegments[2]; 
        
        document.getElementById('customerName').textContent = username;

        function showMenu(event) {
            event.preventDefault()
            loadMenuSection(); 
        }

        function loadCartSection() {
             const pathSegments = window.location.pathname.split('/');
             const username = pathSegments[2];
             
             const newPath = `/customers/${username}/cart`; 
             history.pushState(null, '', newPath); 
             showSection('cart');
         }
         
        function showCart(event) {
             event.preventDefault();
             loadCartSection();
             loadCartItems();
         }
            
        async function loadCartItems() {
            try {
                    const username = pathSegments[2];
                    const response = await fetch(`/customers/${username}/cart`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    const cartItems = await response.json();
            
                    const cartGrid = document.getElementById('cartItems');
                    cartGrid.innerHTML = '';  
            
                    if (cartItems.length > 0) {
                        let totalPrice = 0;
                        cartItems.forEach(item => {
                            totalPrice += item.price;
                            const itemCard = document.createElement('div');
                            itemCard.classList.add('cart-item-card');
                            itemCard.innerHTML = `
                                <div class="cart-item">
                                    <img src="${item.photo_url || '/static/style/img/burger.png'}" 
                                         alt="${item.name}" style="width: 100px; height: 100px;" />
                                    <div class="item-details">
                                        <h4>${item.name}</h4>
                                        <p>${item.description}</p>
                                        <p>Price: $${item.price.toFixed(2)}</p>
                                        <button onclick="removeFromCart('${item.name}')">Remove</button>
                                    </div>
                                </div>
                            `;
                            cartGrid.appendChild(itemCard);
                        });
            
                        const totalSection = document.createElement('div');
                        totalSection.classList.add('cart-total');
                        totalSection.innerHTML = `
                            <div class="total-info">
                                <h3>Total: $${totalPrice.toFixed(2)}</h3>
                                <p>Items: ${cartItems.length}</p>
                            </div>
                            <button onclick="checkout()">Proceed to Checkout</button>
                        `;
                        cartGrid.appendChild(totalSection);
                    } else {
                        cartGrid.innerHTML = '<p>Your cart is empty.</p>';
                    }
            } catch (error) {
                    console.error('Error loading cart items:', error);
                    const cartGrid = document.getElementById('cartItems');
                    cartGrid.innerHTML = '<p>Error loading cart items.</p>';
            }
        }
            
        async function addToCart(itemName) {
            try {
                const username = pathSegments[2];
                const response = await fetch(`/customers/${username}/cart/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        item_name: itemName,
                        quantity: 1
                    })
                });
        
                if (response.ok) {
                    alert('Item added to cart successfully!');
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to add item to cart');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                alert('Failed to add item to cart');
            }
        }
        
        async function removeFromCart(itemName) {
            try {
                const username = pathSegments[2];
                const response = await fetch(`/customers/${username}/cart/remove`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        item_name: itemName,
                        quantity: 1
                    })
                });
        
                if (response.ok) {
                    loadCartItems();
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to remove item from cart');
                }
            } catch (error) {
                console.error('Error removing from cart:', error);
                alert('Failed to remove item from cart');
            }
        }
        
        // Add this after removeFromCart function
        async function checkout() {
            try {
                const username = pathSegments[2];
                const response = await fetch(`/customers/${username}/order/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
        
                if (response.ok) {
                    const orderData = await response.json();
                    alert('Order confirmed successfully!\n' +
                        `Order ID: ${orderData.order_id}\n` +
                        `Delivery Address: ${orderData.delivery_address}\n` +
                        `Estimated Delivery: ${new Date(orderData.estimated_delivery).toLocaleTimeString()}`);
                    
                    const cartGrid = document.getElementById('cartItems');
                    cartGrid.innerHTML = '<p>Your cart is empty.</p>';
                    
                    showSection('orders');
                    
                    await refreshOrders();
                  
                    const orderList = document.getElementById('orderList');
                    const refreshMessage = document.createElement('div');
                    // refreshMessage.className = 'refresh-message';
                    // refreshMessage.innerHTML = '<p style="color: #4CAF50; text-align: center; padding: 10px;">New order placed! Click refresh to see your latest order.</p>';
                    // orderList.insertBefore(refreshMessage, orderList.firstChild);
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to create order');
                }
            } catch (error) {
                console.error('Error during checkout:', error);
                alert('Failed to process checkout');
            }
        }
        
        async function refreshOrders() {
            try {
                const username = pathSegments[2];
                const response = await fetch(`/customers/${username}/orders`);
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newOrderList = doc.getElementById('orderList');
                    
                    if (newOrderList) {
                        const currentOrderList = document.getElementById('orderList');
                        currentOrderList.innerHTML = newOrderList.innerHTML;
                    }
                }
            } catch (error) {
                console.error('Error refreshing orders:', error);
                alert('Failed to refresh orders');
            }
        }

        async function handleLogout(event){
            event.preventDefault();
            try {
                const response = await fetch('/customers/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
    </script>
</body>
</html>

