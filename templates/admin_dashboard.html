<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/style/css/admin.css">
</head>
<body>
    <div class="admin-container">
        <nav class="admin-nav">
            <h1>Admin Dashboard</h1>
            <ul>
                <li><a href="#menus">Manage Menus</a></li>
                <li><a href="#customerList">View Customers</a></li>
                <li><a href="/" onclick="handleLogout(event)">Logout</a></li>
            </ul>
        </nav>

        <div class="content">
            <section id="menus" class="dashboard-section">
                <h2>Menu Management</h2>
                <div class="action-buttons">
                    <button onclick="showCreateMenuForm()">Create New Menu</button>
                </div>
        
                <!-- Menu Creation Form -->
                <div id="createMenuForm" class="menu-form" style="display: none;">
                    <form onsubmit="handleCreateMenu(event)">
                        <div class="form-group">
                            <label for="menuName">Menu Name:</label>
                            <input type="text" id="menuName" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="submit-btn">Create Menu</button>
                            <button type="button" class="cancel-btn" onclick="hideCreateMenuForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Add menu items -->
                <div id="addItemForm" class="menu-form" style="display: none;">
                    <h3>Add Item to <span id="currentMenuName"></span></h3>
                    <form onsubmit="handleAddMenuItem(event)">
                        <div class="form-group">
                            <label for="itemType">Item Type:</label>
                            <select id="itemType" required>
                                <option value="main">Main Dish</option>
                                <option value="side">Side Dish</option>
                                <option value="drink">Drink</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="itemName">Item Name:</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="price">Price:</label>
                            <input type="number" id="price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="description">Description:</label>
                            <textarea id="description" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="photoUrl">Photo URL:</label>
                            <input type="url" id="photoUrl">
                        </div>
                        <!-- In the addItemForm div, modify the form actions -->
                        <div class="form-actions">
                            <button type="submit" class="submit-btn">Add Item</button>
                            <!-- <button type="button" class="cancel-btn" onclick="continueAdding()">Add Another</button> -->
                            <button type="button" class="done-btn" onclick="hideAddItemForm()">Done</button>
                        </div>
                        
                        <!-- Add this JavaScript function -->
                        <script>
                        function continueAdding() {
                            const form = document.querySelector('#addItemForm form');
                            if (form) {
                                form.reset();
                            }
                        }
                        
                        function hideAddItemForm() {
                            const formContainer = document.getElementById('addItemForm');
                            const form = formContainer.querySelector('form');
                            formContainer.style.display = 'none';
                            if (form) {
                                form.reset();
                            }
                            loadMenus();
                            viewMenuItems(document.getElementById('currentMenuName').textContent);
                        }
                        </script>
                    </form>
                </div>
                
                
        
                <!-- Menu Items View -->
                <div id="menuItemsView" class="menu-items-view" style="display: none;">
                    <h3 id="selectedMenuName"></h3>
                    <div id="menuItemsList"></div>
                    <button onclick="hideMenuItems()" class="back-btn">Back to Menus</button>
                </div>
        
                <div id="menuList">
                    <!-- Menus will be loaded here -->
                </div>

                <!-- Move customer section here -->
                <h2 class="customer-heading">Customer List</h2>
                <div id="customerList">
                    <!-- Customers will be loaded here -->
                </div>
            </section>
        </div>
    </div>

    <script>
        // Load menus
        async function loadMenus() {
            try {
                const response = await fetch('/admin/menus');
                const data = await response.json();
                const menuList = document.getElementById('menuList');
                menuList.innerHTML = data.menus.map(menu => `
                    <div class="menu-card" style="border: 1px solid black;">
                        <h3>${menu.name}</h3>
                        <p>Total Items: ${menu.total_items}</p>
                        <p>Total Price: $${menu.total_price.toFixed(2)}</p>
                        <div class="menu-actions">
                            <button onclick="showAddItemForMenu('${menu.name}')" class="add-btn">Add Item</button>
                            <button onclick="viewMenuItems('${menu.name}')" class="view-btn">View Items</button>
                            <button onclick="deleteMenu('${menu.name}')" class="delete-btn">Delete Menu</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading menus:', error);
            }
        }

        // Add this new function to handle showing the add item form for a specific menu
        function showAddItemForMenu(menuName) {
            document.getElementById('currentMenuName').textContent = menuName;
            document.getElementById('addItemForm').style.display = 'block';
        }

        // Load customers
        async function loadCustomers() {
            try {
                const response = await fetch('/admin/customers');
                const data = await response.json();
                const customerList = document.getElementById('customerList');
                customerList.innerHTML = data.customers.map(customer => `
                    <div class="customer-card" style="border: 1px solid black;">
                        <h3>${customer.name}</h3>
                        <p>Username: ${customer.username}</p>
                        <p>Active Orders: ${customer.active_orders}</p>
                        <p>Address: ${customer.default_address}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        // Delete menu
        async function deleteMenu(menuName) {
            if (confirm(`Are you sure you want to delete ${menuName}?`)) {
                try {
                    const response = await fetch(`/admin/menu/${menuName}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        loadMenus();
                    }
                } catch (error) {
                    console.error('Error deleting menu:', error);
                }
            }
        }

        //logout
        async function handleLogout(event){
            event.preventDefault();
            try {
                const response = await fetch('/admin/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Initialize dashboard
        window.onload = () => {
            loadMenus();
            loadCustomers();
        };

        function showCreateMenuForm() {
            document.getElementById('createMenuForm').style.display = 'block';
        }

        function hideCreateMenuForm() {
            document.getElementById('createMenuForm').style.display = 'none';
        }

        async function viewMenuItems(menuName) {
            try {
                const response = await fetch(`/admin/menu/${encodeURIComponent(menuName)}/items`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to fetch menu items');
                }
                
                const data = await response.json();
                document.getElementById('selectedMenuName').textContent = menuName;
                const menuItemsList = document.getElementById('menuItemsList');
                
                const items = data.items || [];
                
                if (items.length === 0) {
                    menuItemsList.innerHTML = '<p>No items in this menu yet.</p>';
                } else {
                    menuItemsList.innerHTML = items.map(item => {
                        // Determine image source based on item type
                        let defaultImage;
                        if (item.cooking_time) {
                            defaultImage = '/static/style/img/burger.png';
                        } else if (item.is_vegetarian !== undefined) {
                            defaultImage = '/static/style/img/salad.png';
                        } else if (item.temperature) {
                            defaultImage = '/static/style/img/noodle.png';
                        } else {
                            defaultImage = '/static/style/img/pizza.png';
                        }

                        return `
                            <div class="item-card">
                                <img src="${item.photo_url || defaultImage}" alt="${item.name}" 
                                    onerror="this.src='/static/style/img/burger.png'" 
                                    style="width: 150px">
                                <div class="item-details">
                                    <h4>${item.name}</h4>
                                    <p>${item.description}</p>
                                    <p>Price: $${item.price.toFixed(2)}</p>
                                    ${item.cooking_time ? `<p>Cooking Time: ${item.cooking_time} mins</p>` : ''}
                                    ${item.is_vegetarian !== undefined ? `<p>Vegetarian: ${item.is_vegetarian ? 'Yes' : 'No'}</p>` : ''}
                                    ${item.temperature ? `<p>Temperature: ${item.temperature}</p>` : ''}
                                </div>
                                <div class="item-actions">
                                    <button onclick="deleteMenuItem('${menuName}', '${item.name}')" class="delete-btn">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                document.getElementById('menuList').style.display = 'none';
                document.getElementById('menuItemsView').style.display = 'block';
            } catch (error) {
                console.error('Error loading menu items:', error);
            }
        }

        function hideMenuItems() {
            document.getElementById('menuList').style.display = 'block';
            document.getElementById('menuItemsView').style.display = 'none';
            document.getElementById('menuItemsList').innerHTML = '';
        }

        async function deleteMenuItem(menuName, itemName) {
            if (confirm(`Are you sure you want to delete ${itemName}?`)) {
                try {
                    const response = await fetch(`/admin/menu/${menuName}/items/${itemName}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        const menuResponse = await fetch(`/admin/menu/${encodeURIComponent(menuName)}/items`);
                        const menuData = await menuResponse.json();
                        
                        if (!menuData.items || menuData.items.length === 0) {
                            hideMenuItems();
                        } else {
                            viewMenuItems(menuName);
                        }
                        loadMenus();
                    }
                } catch (error) {
                    console.error('Error deleting menu item:', error);
                    alert('Failed to delete menu item');
                }
            }
        }

        // Update handleCreateMenu function
        async function handleCreateMenu(event) {
            event.preventDefault();
            const menuName = document.getElementById('menuName').value;
            console.log(menuName);

            try {
                const response = await fetch(`/admin/menu/create?name=${encodeURIComponent(menuName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: menuName,
                        
                    })
                });
                console.log(response)

                if (response.ok) {
                    document.getElementById('currentMenuName').textContent = menuName;
                    document.getElementById('addItemForm').style.display = 'block';
                    await loadMenus();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to create menu');
                }
            } catch (error) {
                console.error('Error creating menu:', error);
                alert('Failed to create menu');
            }
        }

        async function handleAddMenuItem(event) {
            event.preventDefault();
            const menuName = document.getElementById('currentMenuName').textContent;
            const itemType = document.getElementById('itemType').value;
            const itemName = document.getElementById('itemName').value;
            const price = document.getElementById('price').value;
            const description = document.getElementById('description').value;
            
            // Set default image based on item type
            let defaultImage;
            if (itemType === 'main') {
                defaultImage = '/static/style/img/burger.png';
            } else if (itemType === 'side') {
                defaultImage = '/static/style/img/salad.png';
            } else if (itemType === 'drink') {
                defaultImage = '/static/style/img/pizza.png';
            }

            let itemData = {
                name: itemName,
                price: parseFloat(price),
                description: description,
                photo_url: defaultImage
            };

            // Add type-specific properties
            if (itemType === 'main') {
                itemData.cooking_time = 15;
            } else if (itemType === 'side') {
                itemData.is_vegetarian = true;
            } else if (itemType === 'drink') {
                itemData.temperature = 'COLD';
            }

            try {
                const response = await fetch(`/admin/menu/${encodeURIComponent(menuName)}/items?item_type=${itemType}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(itemData)
                });

                if (response.ok) {
                    const addItemForm = document.querySelector('#addItemForm form');
                    if (addItemForm) {
                        addItemForm.reset();
                    } 
                    hideAddItemForm();
                    await loadMenus(); 
                    await viewMenuItems(menuName); 
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to add item');
                }
            } catch (error) {
                console.error('Error adding menu item:', error);
                alert('Failed to add item');
            }
        }

        async function viewMenuItems(menuName) {
            try {
                const response = await fetch(`/admin/menu/${encodeURIComponent(menuName)}/items`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to fetch menu items');
                }
                
                const data = await response.json();
                document.getElementById('selectedMenuName').textContent = menuName;
                const menuItemsList = document.getElementById('menuItemsList');
                
                // Initialize empty array if items is undefined
                const items = data.items || [];
                
                if (items.length === 0) {
                    menuItemsList.innerHTML = '<p>No items in this menu yet.</p>';
                } else {
                    menuItemsList.innerHTML = items.map(item => `
                        <div class="item-card">
                            <img src="${item.photo_url || '/static/style/img/burger.png'}" alt="${item.name}" style="width: 50%; height: 50%;">
                            <div class="item-details">
                                <h4>${item.name}</h4>
                                <p>${item.description}</p>
                                <p>Price: $${item.price.toFixed(2)}</p>
                                ${item.cooking_time ? `<p>Cooking Time: ${item.cooking_time} mins</p>` : ''}
                                ${item.is_vegetarian !== undefined ? `<p>Vegetarian: ${item.is_vegetarian ? 'Yes' : 'No'}</p>` : ''}
                                ${item.temperature ? `<p>Temperature: ${item.temperature}</p>` : ''}
                            </div>
                            <div class="item-actions">
                                <button onclick="deleteMenuItem('${menuName}', '${item.name}')" class="delete-btn">Delete</button>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('menuList').style.display = 'none';
                document.getElementById('menuItemsView').style.display = 'block';
            } catch (error) {
                console.error('Error loading menu items:', error);
                menuItemsList.innerHTML = '<p>Error loading menu items. Please try again.</p>';
            }
        }
        function hideAddItemForm() {
            const formContainer = document.getElementById('addItemForm');
            const form = formContainer.querySelector('form');
            formContainer.style.display = 'none';
            if (form) {
                form.reset();
            }
            loadMenus();
        }
    </script>
</body>
</html>